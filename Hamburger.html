<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hamburger Defender 7.0 - Solid Obstacles</title>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 10px;
            overflow: hidden;
        }

        h1 { margin: 5px 0; font-size: 20px; color: #f1c40f; text-shadow: 2px 2px #000; }
        
        #game-container {
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            border: 8px solid #8e44ad;
            border-radius: 4px;
        }

        canvas {
            background-color: #e67e22; 
            display: block;
        }

        #controls {
            margin-top: 15px;
            display: grid;
            grid-template-columns: 70px 70px 70px;
            gap: 10px;
            text-align: center;
        }

        .btn {
            background-color: #34495e;
            border-bottom: 4px solid #1abc9c;
            border-radius: 8px;
            color: white;
            font-size: 24px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }
        
        .btn:active { transform: translateY(4px); border-bottom: 0; }
        .btn-punch { background-color: #c0392b; border-bottom: 4px solid #e74c3c; grid-column: 2; font-weight: bold; font-size: 16px; }

        #status {
            background: #000;
            width: 320px;
            padding: 5px;
            text-align: center;
            font-size: 14px;
            color: #2ecc71;
            border-top: 2px solid #555;
        }

        #instructions {
            font-size: 12px;
            color: #bdc3c7;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <h1>üçî Caccia all'Hamburger üçî</h1>
    
    <div id="game-container">
        <canvas id="gameCanvas" width="340" height="340"></canvas>
        <div id="status">PROTEGGI L'HAMBURGER!</div>
    </div>

    <div id="instructions">Usa FRECCE per muoverti - SPAZIO per picchiare/ricominciare</div>

    <div id="controls">
        <div class="btn" onclick="simulateKey('ArrowLeft')">‚¨ÖÔ∏è</div>
        <div class="btn" onclick="simulateKey('ArrowDown')">‚¨áÔ∏è</div>
        <div class="btn" onclick="simulateKey('ArrowRight')">‚û°Ô∏è</div>
        <div class="btn" style="grid-column: 1;" onclick="simulateKey('ArrowUp')">‚¨ÜÔ∏è</div>
        <div class="btn btn-punch" onclick="punch()">üëä PUGNO</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('status');

        // --- STATO DEL GIOCO ---
        let gameActive = false; 
        let gameWon = false;
        let keys = {};
        
        let player = { x: 155, y: 250, w: 24, h: 36, speed: 3.5, isPunching: false };
        let burger = { x: 155, y: 300, w: 30, h: 25, active: true };
        
        let enemies = [
            { x: 30, y: -40, w: 24, h: 36, speed: 0.8, active: true, stunned: 0, type: 1 },
            { x: 280, y: -40, w: 24, h: 36, speed: 0.9, active: true, stunned: 0, type: 2 }
        ];

        // I tavoli ora sono vuoti all'inizio e generati random
        let tables = [];

        let police = { x: -100, y: 150, visible: false };

        // --- DISEGNO ---
        function drawHuman(x, y, colorHead, colorBody, colorLegs, isPunching, isEnemy, isStunned) {
            ctx.save();
            if(isStunned > 0) {
                x += Math.random() * 4 - 2;
                y += Math.random() * 4 - 2;
            }

            // Testa
            ctx.fillStyle = colorHead;
            ctx.fillRect(x + 4, y, 16, 14);
            
            // Occhi
            ctx.fillStyle = "black";
            if (isEnemy) {
                ctx.fillRect(x + 6, y + 4, 4, 2);
                ctx.fillRect(x + 14, y + 4, 4, 2);
            } else {
                ctx.fillRect(x + 7, y + 4, 2, 2);
                ctx.fillRect(x + 15, y + 4, 2, 2);
            }

            // Corpo
            ctx.fillStyle = colorBody;
            ctx.fillRect(x + 2, y + 14, 20, 14);

            // Braccia
            ctx.fillStyle = colorBody;
            if (isPunching) {
                ctx.fillRect(x + 22, y + 14, 12, 6); 
                ctx.fillStyle = "#ffcccc"; 
                ctx.fillRect(x + 34, y + 14, 4, 6);
            } else {
                ctx.fillRect(x - 2, y + 14, 4, 12); 
                ctx.fillRect(x + 22, y + 14, 4, 12); 
            }

            // Gambe
            ctx.fillStyle = colorLegs;
            ctx.fillRect(x + 4, y + 28, 6, 8);
            ctx.fillRect(x + 14, y + 28, 6, 8);

            if (isStunned > 0) {
                ctx.fillStyle = "yellow";
                ctx.font = "16px Arial";
                ctx.fillText("üí´", x + 5, y - 5);
            }
            ctx.restore();
        }

        function drawBackground() {
            ctx.fillStyle = "#d35400"; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.strokeStyle = "#e67e22"; 
            ctx.lineWidth = 1;
            let tileSize = 40;
            
            for(let i=0; i<canvas.width; i+=tileSize) {
                ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i, canvas.height); ctx.stroke();
            }
            for(let i=0; i<canvas.height; i+=tileSize) {
                ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width, i); ctx.stroke();
            }

            ctx.fillStyle = "#2c3e50";
            ctx.fillRect(120, 0, 100, 20);
            ctx.fillStyle = "#fff";
            ctx.font = "10px Arial";
            ctx.fillText("BENVENUTI", 140, 14);

            tables.forEach(t => {
                ctx.fillStyle = "white";
                // Disegna tavolo come cerchio visivamente
                ctx.beginPath(); ctx.arc(t.x + t.w/2, t.y + t.h/2, 25, 0, Math.PI*2); ctx.fill();
                // Tovaglia
                let cx = t.x + t.w/2;
                let cy = t.y + t.h/2;
                ctx.fillStyle = "#c0392b";
                ctx.fillRect(cx-15, cy-15, 10, 10);
                ctx.fillRect(cx+5, cy-15, 10, 10);
                ctx.fillRect(cx-15, cy+5, 10, 10);
                ctx.fillRect(cx+5, cy+5, 10, 10);
                
                // Debug hitbox (opzionale, scommentare per vedere i quadrati di collisione)
                // ctx.strokeStyle = "yellow"; ctx.strokeRect(t.x, t.y, t.w, t.h);
            });
        }

        function drawBurger() {
            if (!burger.active) return;
            let bx = burger.x; let by = burger.y;
            
            ctx.fillStyle = "#f39c12"; ctx.fillRect(bx, by + 15, 30, 10);
            ctx.fillStyle = "#5d4037"; ctx.fillRect(bx - 2, by + 10, 34, 8);
            ctx.fillStyle = "#f1c40f"; ctx.beginPath(); ctx.moveTo(bx, by+10); ctx.lineTo(bx+10, by+15); ctx.lineTo(bx+20, by+10); ctx.fill();
            ctx.fillStyle = "#2ecc71"; ctx.fillRect(bx - 2, by + 6, 34, 4);
            ctx.fillStyle = "#f39c12"; ctx.beginPath(); ctx.arc(bx + 15, by + 6, 15, Math.PI, 0); ctx.fill();
            ctx.fillStyle = "#fff"; ctx.fillRect(bx+10, by, 2, 2); ctx.fillRect(bx+20, by+2, 2, 2);
        }

        function draw() {
            drawBackground();
            drawBurger();

            let py = gameWon ? player.y - Math.abs(Math.sin(Date.now()/100)*10) : player.y;
            drawHuman(player.x, py, "#ffccaa", "#3498db", "#2c3e50", player.isPunching, false, 0);

            enemies.forEach(e => {
                if (e.active) {
                    let bodyColor = e.type === 1 ? "#2c3e50" : "#8e44ad"; 
                    drawHuman(e.x, e.y, "#ffccaa", bodyColor, "#000", false, true, e.stunned);
                }
                
                if (gameWon && e.active) {
                    ctx.strokeStyle = "#7f8c8d";
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    for(let i=0; i<=30; i+=8) {
                        ctx.moveTo(e.x + i, e.y); ctx.lineTo(e.x + i, e.y + 40);
                    }
                    ctx.stroke();
                }
            });

            if (police.visible) {
                drawHuman(police.x, police.y, "#ffccaa", "#2980b9", "#2c3e50", false, false, 0);
                ctx.fillStyle = "#2980b9"; ctx.fillRect(police.x + 2, police.y - 4, 20, 6);
                ctx.fillStyle = "gold"; ctx.fillRect(police.x + 10, police.y - 6, 4, 4); 
                
                if (Math.floor(Date.now() / 200) % 2 === 0) {
                    ctx.fillStyle = "red"; ctx.beginPath(); ctx.arc(police.x - 10, police.y, 5, 0, Math.PI*2); ctx.fill();
                } else {
                    ctx.fillStyle = "blue"; ctx.beginPath(); ctx.arc(police.x + 35, police.y, 5, 0, Math.PI*2); ctx.fill();
                }
            }
        }

        // Funzione universale per collisioni tra rettangoli
        function rectIntersect(r1, r2) {
            return (r1.x < r2.x + r2.w &&
                    r1.x + r1.w > r2.x &&
                    r1.y < r2.y + r2.h &&
                    r1.y + r2.h > r2.y);
        }

        // Controlla se una posizione futura √® valida (niente muri, niente ostacoli)
        function canMove(actor, newX, newY, isPlayer) {
            let tempActor = { x: newX, y: newY, w: actor.w, h: actor.h };
            
            // 1. Controllo Muri (Tavoli)
            for(let t of tables) {
                if (rectIntersect(tempActor, t)) return false; // Bloccato dal tavolo
            }

            // 2. Controllo Cattivi (Se sei il player)
            // L'utente ha chiesto: "non si pu√≤ passare sopra neanche i cattivi"
            if (isPlayer) {
                for(let e of enemies) {
                    // Se tocchi un cattivo, √® un blocco fisico.
                    // (La morte avviene in una funzione separata, qui controlliamo solo il movimento)
                    if (e.active && rectIntersect(tempActor, e)) return false; 
                }
            }

            // 3. Controllo Player (Se sei un cattivo)
            // I cattivi non dovrebbero passarci sopra
            if (!isPlayer && gameActive) {
                if(rectIntersect(tempActor, player)) return false;
            }

            return true;
        }

        function update() {
            if (!gameActive) return;

            // --- MOVIMENTO GIOCATORE CON COLLISIONI ---
            let nextX = player.x;
            let nextY = player.y;

            if (keys['ArrowUp']) nextY -= player.speed;
            if (keys['ArrowDown']) nextY += player.speed;
            if (keys['ArrowLeft']) nextX -= player.speed;
            if (keys['ArrowRight']) nextX += player.speed;

            // Limiti Canvas
            if (nextX < 0) nextX = 0;
            if (nextX > canvas.width - player.w) nextX = canvas.width - player.w;
            if (nextY < 0) nextY = 0; // Lasciamo spazio per l'header
            if (nextY > canvas.height - player.h) nextY = canvas.height - player.h;

            // Applica movimento solo se non c'√® collisione con tavoli o nemici
            // Proviamo a muovere X
            if (canMove(player, nextX, player.y, true)) {
                player.x = nextX;
            }
            // Proviamo a muovere Y
            if (canMove(player, player.x, nextY, true)) {
                player.y = nextY;
            }


            // --- MOVIMENTO NEMICI CON COLLISIONI ---
            enemies.forEach(e => {
                if (e.active && e.stunned <= 0) {
                    let moveX = 0;
                    let moveY = 0;
                    
                    if (e.x < burger.x) moveX = e.speed;
                    if (e.x > burger.x) moveX = -e.speed;
                    if (e.y < burger.y) moveY = e.speed;
                    if (e.y > burger.y) moveY = -e.speed;

                    // I nemici provano a muoversi. Se sbattono contro un tavolo, si fermano su quell'asse
                    if (canMove(e, e.x + moveX, e.y, false)) e.x += moveX;
                    if (canMove(e, e.x, e.y + moveY, false)) e.y += moveY;

                } 
                else if (e.stunned > 0) {
                    e.stunned--;
                }

                // Controllo sconfitta (se tocchi un nemico attivo)
                // Anche se sono solidi, se li tocchi muori
                if (rectIntersect(player, e) && e.stunned <= 0) {
                    gameOver(false);
                }

                // Nemico mangia hamburger
                if (rectIntersect(e, burger) && burger.active && e.stunned <= 0) {
                    gameOver(false);
                }
            });
        }

        function punch() {
            if (!gameActive) {
                resetGame();
                return;
            }

            if (player.isPunching) return;

            player.isPunching = true;
            setTimeout(() => player.isPunching = false, 200);

            let hit = false;
            enemies.forEach(e => {
                let dx = Math.abs(player.x - e.x);
                let dy = Math.abs(player.y - e.y);
                
                // Raggio del pugno
                if (dx < 50 && dy < 50) {
                    e.stunned = 120; 
                    // Pushback: il pugno li spinge indietro anche se ci sono muri (piccola eccezione per non bloccarli)
                    e.y -= 40; 
                    hit = true;
                }
            });

            if (hit) statusEl.innerText = "üí• BOOM! PRESO! üí•";
            else statusEl.innerText = "Pugno a vuoto!";
        }

        function gameOver(win) {
            gameActive = false;
            if (win) {
                // Vittoria gestita dal loop
            } else {
                gameWon = false;
                burger.active = false;
                statusEl.innerText = "HAI PERSO! (Premi SPAZIO)";
                statusEl.style.color = "red";
            }
        }
        
        setInterval(() => {
            if (gameActive && rectIntersect(player
